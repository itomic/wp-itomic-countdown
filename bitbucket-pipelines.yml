image: php:8.1

pipelines:
  default:
    - step:
        name: PHP Syntax Check
        caches:
          - composer
        script:
          - apt-get update && apt-get install -y git zip unzip
          - php -l itomic-countdown.php
          - php -l uninstall.php
          - find assets -name "*.php" -exec php -l {} \;
        artifacts:
          - deploy/**
    - step:
        name: WordPress Coding Standards
        caches:
          - composer
        script:
          - apt-get update && apt-get install -y git zip unzip
          - composer global require squizlabs/php_codesniffer
          - composer global require wp-coding-standards/wpcs
          - ~/.composer/vendor/bin/phpcs --standard=WordPress itomic-countdown.php
          - ~/.composer/vendor/bin/phpcs --standard=WordPress assets/
        artifacts:
          - deploy/**
    - step:
        name: Build Plugin Package
        script:
          - apt-get update && apt-get install -y git zip unzip
          - chmod +x deploy.sh
          - ./deploy.sh
        artifacts:
          - deploy/**

  branches:
    main:
      - step:
          name: Deploy to Update Server
          script:
            - apt-get update && apt-get install -y openssh-client zip unzip
            - chmod +x deploy.sh
            - echo "Running deploy script..."
            - ./deploy.sh
            - echo "Deploy script completed with exit code $?"
            - echo "Checking if deploy directory exists..."
            - ls -la
            - echo "Contents of deploy directory..."
            - ls -la deploy/ || echo "Deploy directory not found"
            - echo "Looking for ZIP files..."
            - find . -name "*.zip" -type f || echo "No ZIP files found"
            - echo "Checking if ZIP files exist before SCP..."
            - if [ -f deploy/itomic-countdown-*.zip ]; then echo "ZIP files found"; else echo "No ZIP files found, cannot continue"; exit 1; fi
            - ls -la deploy/*.zip
            - cat deploy/version.json
            - scp -o StrictHostKeyChecking=no deploy/itomic-countdown-*.zip root@pegasus.itomic.com:/home/itomicau/public_html/plugins/itomic-countdown/
            - scp -o StrictHostKeyChecking=no deploy/version.json root@pegasus.itomic.com:/home/itomicau/public_html/plugins/itomic-countdown/
            - scp -o StrictHostKeyChecking=no deploy/info.json root@pegasus.itomic.com:/home/itomicau/public_html/plugins/itomic-countdown/
            - ssh -o StrictHostKeyChecking=no root@pegasus.itomic.com "chown itomicau:itomicau /home/itomicau/public_html/plugins/itomic-countdown/*"
          artifacts:
            - deploy/**

definitions:
  caches:
    composer: ~/.composer/cache 